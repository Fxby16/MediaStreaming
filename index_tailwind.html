<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Streaming Auth</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .auth-step { transition: all 0.3s ease; }
    .video-card:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <!-- Header -->
  <header class="bg-black py-4 px-6 flex justify-between items-center border-b border-gray-800">
    <h1 class="text-2xl font-bold text-red-600">STREAMFLIX</h1>
    <button id="logout-btn" class="hidden bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md transition">
      Logout
    </button>
  </header>

  <!-- Main Content -->
  <div class="flex">
    <!-- Chat Sidebar -->
    <div id="chat-sidebar" class="hidden w-64 bg-gray-800 h-screen p-4 border-r border-gray-700 overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Your Chats</h2>
      <ul id="chat-list"></ul>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="max-w-md mx-auto mt-20 p-8 bg-gray-800 rounded-lg shadow-xl">
      <!-- Step 1: Phone -->
      <div id="step-phone" class="auth-step">
        <h2 class="text-xl font-semibold mb-6 text-center">Enter Your Phone Number</h2>
        <input 
          type="text" 
          id="phone_number" 
          placeholder="+39 123 456 7890" 
          class="w-full px-4 py-3 bg-gray-700 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-red-500"
        />
        <button 
          onclick="sendPhone()"
          class="w-full bg-red-600 hover:bg-red-700 py-3 rounded-md font-medium transition"
        >
          Continue
        </button>
      </div>

      <!-- Step 2: Code -->
      <div id="step-code" class="auth-step hidden">
        <h2 class="text-xl font-semibold mb-6 text-center">Verification Code</h2>
        <input 
          type="text" 
          id="code" 
          placeholder="Enter 6-digit code" 
          class="w-full px-4 py-3 bg-gray-700 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-red-500"
        />
        <button 
          onclick="sendCode()"
          class="w-full bg-red-600 hover:bg-red-700 py-3 rounded-md font-medium transition"
        >
          Verify
        </button>
      </div>

      <!-- Step 3: Password -->
      <div id="step-password" class="auth-step hidden">
        <h2 class="text-xl font-semibold mb-6 text-center">Two-Factor Authentication</h2>
        <input 
          type="password" 
          id="password" 
          placeholder="Your 2FA password" 
          class="w-full px-4 py-3 bg-gray-700 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-red-500"
        />
        <button 
          onclick="sendPassword()"
          class="w-full bg-red-600 hover:bg-red-700 py-3 rounded-md font-medium transition"
        >
          Complete Login
        </button>
      </div>
    </div>

    <!-- Video UI (Hidden Initially) -->
    <div id="video-ui" class="hidden flex-1 p-6">
      <div class="flex justify-between items-center mb-6">
        <button id="toggle-sidebar" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md transition">
          ☰ Toggle Chats
        </button>
        <h2 class="text-2xl font-bold">Your Videos</h2>
        <div class="w-32"></div> <!-- Spacer for alignment -->
      </div>
      
      <!-- Video Grid -->
      <div id="video-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
        <!-- Dynamically populated by JS -->
      </div>
    </div>
  </div>

  <!-- Video Player -->
  <div id="video-container" class="hidden fixed inset-0 z-50 bg-black bg-opacity-90 flex items-center justify-center">
    <div class="relative w-full max-w-4xl">
      <button 
        onclick="document.getElementById('video-container').classList.add('hidden')" 
        class="absolute -top-10 right-0 text-gray-400 hover:text-white"
      >
        ✕ Close
      </button>
      <video id="player" controls class="w-full" autoplay>
        Your browser does not support the video tag.
      </video>
    </div>
  </div>

  <script>
    const server = `http://${window.location.hostname}:10000`;
    const DEFAULT_THUMBNAIL = "https://sm.ign.com/t/ign_it/screenshot/default/x_8v92.1280.jpg";

    console.log('Server:', server);

    let session_id = 0;
    let chats = [];
    let currentChatId = null;

    window.onload = function() {
      const cookie = document.cookie.split('; ').find(row => row.startsWith('session_id='));
      if (cookie) {
        session_id = cookie.split('=')[1];
        console.log('Session ID from cookie:', session_id);
        checkState();
      } else {
        sendApi();
      }

      // Toggle sidebar
      document.getElementById('toggle-sidebar').onclick = () => {
        const sidebar = document.getElementById('chat-sidebar');
        sidebar.classList.toggle('hidden');
      };
    };

    function sendApi() {
      fetch(`${server}/auth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start_auth: true, session_id: Number(session_id) })
      })
      .then(res => res.json())
      .then(data => {
        session_id = data['session_id'];
        console.log('Session ID:', session_id);

        document.cookie = `session_id=${session_id}; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/`;

        checkState();
      });
    }

    function sendPhone() {
      const phone_number = document.getElementById('phone_number').value;
      console.log('Sending phone number:', phone_number);

      fetch(`${server}/auth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone_number, session_id })
      })
      .then(() => checkState());
    }

    function sendCode() {
      const code = document.getElementById('code').value;
      console.log('Sending code:', code);

      fetch(`${server}/auth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code, session_id })
      })
      .then(() => checkState());
    }

    function checkState() {
      console.log('Checking state...');
      fetch(`${server}/auth/get_state?session_id=${session_id}`)
        .then(res => res.json())
        .then(state => {
          console.log('Current state:', state);
          switch (state['state']) {
            case 'authorizationStateWaitTdlibParameters':
              console.log('Waiting for TDLib parameters...');
              sendApi();
              break;
            case 'authorizationStateWaitPassword':
              showStep('step-password');
              break;
            case 'authorizationStateWaitPhoneNumber':
              showStep('step-phone');
              break;
            case 'authorizationStateWaitCode':
              showStep('step-code');
              break;
            case 'authorizationStateReady':
              document.getElementById('auth-container').classList.add('hidden');
              document.getElementById('video-ui').classList.remove('hidden');
              document.getElementById('chat-sidebar').classList.remove('hidden');
              
              const logoutBtn = document.getElementById('logout-btn');
              logoutBtn.classList.remove('hidden');
              logoutBtn.onclick = () => {
                fetch(`${server}/logout?session_id=${session_id}`)
                  .then(() => {
                    session_id = 0;
                    document.cookie = 'session_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.reload();
                  });
              };
              
              getChats();
              break;
            default:
              console.log('Unknown state:', state);
              return checkState();
          }
        });
    }

    function showStep(id) {
      document.querySelectorAll('.auth-step').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function getFiles(chat_id) {
      currentChatId = chat_id;
      fetch(`${server}/get_files?session_id=${session_id}&chat_id=${chat_id}`)
        .then(res => res.json())
        .then(data => {
          const videoGrid = document.getElementById('video-grid');
          videoGrid.innerHTML = '';

          data.forEach(file => {
            const card = document.createElement('div');
            card.className = 'video-card bg-gray-800 rounded-lg overflow-hidden cursor-pointer transition hover:scale-105';
            card.onclick = () => playVideo(file);
            
            card.innerHTML = `
              <div class="relative pb-[150%] bg-gray-700">
                <img 
                  src="${DEFAULT_THUMBNAIL}" 
                  alt="${file['file_name']}" 
                  class="absolute h-full w-full object-cover"
                >
              </div>
              <div class="p-3">
                <h3 class="font-medium truncate">${file['file_name']}</h3>
                <p class="text-sm text-gray-400 truncate">${file['remote_id']}</p>
              </div>
            `;
            
            videoGrid.appendChild(card);
          });
        });
    }

    function getChats() {
      if(chats.length > 0) {
        updateChatList();
      } else {
        fetch(`${server}/get_chats?session_id=${session_id}`)
          .then(res => res.json())
          .then(data => {
            chats = data;
            updateChatList();
          }); 
      }
    }

    function updateChatList() {
      const chatList = document.getElementById('chat-list');
      chatList.innerHTML = '';
      
      chats.forEach(chat => {
        const li = document.createElement('li');
        li.className = 'mb-2 p-2 hover:bg-gray-700 rounded cursor-pointer';
        li.textContent = chat['title'];
        li.onclick = () => getFiles(chat['id']);
        chatList.appendChild(li);
      });

      // If we have a current chat selected, highlight it
      if (currentChatId) {
        const currentChat = document.querySelector(`[data-chat-id="${currentChatId}"]`);
        if (currentChat) {
          currentChat.classList.add('bg-gray-700');
        }
      }
    }

    function playVideo(file) {
      const container = document.getElementById('video-container');
      const player = document.getElementById('player');
      
      player.innerHTML = `
        <source 
          src="${server}/video?file_id=${file['id']}&session_id=${session_id}" 
          type="${file['mime_type']}"
        >
      `;
      
      container.classList.remove('hidden');
      player.load();
      player.play();
    }
  </script>
</body>
</html>