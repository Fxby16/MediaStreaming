<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Streaming Auth</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header id="header">
    <h1>Welcome to Streaming</h1>
  </header>
  <div class="container" id="auth-container">
    <div id="step-phone" class="auth-step" style="display: none;">
      <input type="text" id="phone_number" placeholder="Phone Number" />
      <button onclick="sendPhone()">Next</button>
    </div>

    <div id="step-code" class="auth-step" style="display:none;">
      <input type="text" id="code" placeholder="Authentication Code" />
      <button onclick="sendCode()">Next</button>
    </div>

    <div id="step-password" class="auth-step" style="display:none;">
      <input type="password" id="password" placeholder="2FA Password (if any)" />
      <button onclick="sendPassword()">Finish</button>
    </div>
  </div>

  <div class="container" id="video-ui" style="display: none;">
    <h2>Available Videos</h2>
    <ul id="video-list"></ul>
    <div id="video-container"></div>
  </div>

  <script>
    const server = `http://${window.location.hostname}:10000`;

    console.log('Server:', server);

    let session_id = 0;
    let chats = [];

    window.onload = function() {
      const cookie = document.cookie.split('; ').find(row => row.startsWith('session_id='));
      if (cookie) {
        session_id = cookie.split('=')[1];
        console.log('Session ID from cookie:', session_id);
        checkState();
      } else {
        sendApi();
      }
    };
  
    function sendApi() {
      fetch(`${server}/auth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start_auth: true, session_id: Number(session_id) })
      })
      .then(res => res.json())
      .then(data => {
        session_id = data['session_id'];
        console.log('Session ID:', session_id);

        document.cookie = `session_id=${session_id}; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/`;

        checkState();
      });
    }
  
    function sendPhone() {
      const phone_number = document.getElementById('phone_number').value;
      console.log('Sending phone number:', phone_number);
  
      fetch(`${server}/auth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone_number, session_id })
      })
      .then(() => checkState());
    }
  
    function sendCode() {
      const code = document.getElementById('code').value;
      console.log('Sending code:', code);
  
      fetch(`${server}/auth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code, session_id })
      })
      .then(() => checkState());
    }
  
    function checkState() {
      console.log('Checking state...');
      fetch(`${server}/auth/get_state?session_id=${session_id}`)
        .then(res => res.json())
        .then(state => {
          console.log('Current state:', state);
          switch (state['state']) {
            case 'authorizationStateWaitTdlibParameters':
              console.log('Waiting for TDLib parameters...');
              sendApi();
              break;
            case 'authorizationStateWaitPassword':
              showStep('step-password');
              break;
            case 'authorizationStateWaitPhoneNumber':
              showStep('step-phone');
              break;
            case 'authorizationStateWaitCode':
              showStep('step-code');
              break;
            case 'authorizationStateReady':
              document.getElementById('auth-container').style.display = 'none';
              document.getElementById('video-ui').style.display = 'block';
              getChats();

              let logoutButton = document.createElement('button');
              logoutButton.textContent = 'Logout';
              logoutButton.onclick = () => {
                fetch(`${server}/logout?session_id=${session_id}`)
                  .then(() => {
                    session_id = 0;
                    document.cookie = 'session_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.reload();
                  });
              };
              document.getElementById('header').appendChild(logoutButton);
              break;
            default:
              console.log('Unknown state:', state);
              return checkState();
          }
        });
    }
  
    function showStep(id) {
      document.querySelectorAll('.auth-step').forEach(el => el.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }
  
    function getFiles(chat_id) {
      fetch(`${server}/get_files?session_id=${session_id}&chat_id=${chat_id}`)
        .then(res => res.json())
        .then(data => {
          const videoList = document.getElementById('video-list');
          videoList.innerHTML = '';
          const backButton = document.createElement('button');
          backButton.textContent = 'Back';
          backButton.onclick = () => getChats();
          videoList.appendChild(backButton);

          console.log('Chat ID:', chat_id);
          console.log(data);

          data.forEach(file => {
            const li = document.createElement('li');
            li.textContent = file['file_name'] + ' ' + file["remote_id"];
            li.onclick = () => playVideo(file);
            videoList.appendChild(li);
          });
        });
    }

    function getChats() {
      if(chats.length > 0) {
        const videoList = document.getElementById('video-list');
        videoList.innerHTML = '';
        const backButton = document.createElement('button');
        backButton.textContent = 'Back';
        backButton.onclick = () => getChats();
        videoList.appendChild(backButton);
        console.log('Using cached chats:', chats);
        chats.forEach(chat => {
          const li = document.createElement('li');
          li.textContent = chat['title'];
          li.onclick = () => getFiles(chat['id']);
          videoList.appendChild(li);
        });
      }else{
        fetch(`${server}/get_chats?session_id=${session_id}`)
        .then(res => res.json())
        .then(data => {
          const videoList = document.getElementById('video-list');
          videoList.innerHTML = '';
          chats = data;
          data.forEach(chat => {
            const li = document.createElement('li');
            li.textContent = chat['title'];
            li.onclick = () => getFiles(chat['id']);
            videoList.appendChild(li);
          });
        }); 
      } 
    }
  
    function playVideo(file) {
      const videoContainer = document.getElementById('video-container');
      videoContainer.innerHTML = '';

      const video = document.createElement('video');
      video.controls = true;
      video.style.width = '100%';
      video.style.height = 'auto';

      const source = document.createElement('source');
      source.src = `${server}/video?file_id=${file['id']}&session_id=${session_id}`;
      source.type = file['mime_type'];

      video.appendChild(source);
      videoContainer.appendChild(video);

      videoContainer.appendChild(video);
    }
  </script>
  
</body>
</html>
